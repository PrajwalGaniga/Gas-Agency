<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Management | GasFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .animate-slide-in { animation: slideIn 0.4s ease-out forwards; }
        .animate-pulse { animation: pulse 2s infinite; }
        .animate-modal-in { animation: modalFadeIn 0.3s ease-out forwards; }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .gradient-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .gradient-info {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        .gradient-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-badge {
            font-size: 0.7rem;
            letter-spacing: 0.5px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .mobile-only { display: block; }
        .desktop-only { display: none; }
        
        @media (min-width: 768px) {
            .mobile-only { display: none; }
            .desktop-only { display: block; }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }
        
        /* Table hover effect */
        .table-row-hover:hover { 
            background-color: #f9fafb; 
            transition: background-color 0.2s ease;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
        }
        
        .modal-overlay.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        
        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(100%);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        .notification.info { background: #3b82f6; }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    
    <!-- Mobile Navigation -->
    <div class="mobile-only fixed top-4 left-4 z-40">
        <button onclick="window.history.back()" class="gradient-primary text-white p-3 rounded-xl shadow-lg">
            <i class="fas fa-arrow-left"></i>
        </button>
    </div>
    
    <!-- Navigation -->
    <nav class="gradient-primary text-white shadow-xl sticky top-0 z-30">
        <div class="container mx-auto px-4 lg:px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Customer Management</h1>
                        <p class="text-xs opacity-80">{{ customers|length }} customers registered</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <div class="desktop-only flex items-center space-x-2 bg-white bg-opacity-10 px-3 py-1.5 rounded-lg">
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        <span class="text-xs font-medium">Live</span>
                    </div>
                    
                    <button onclick="openModal('addCityModal')" class="px-4 py-2 bg-white bg-opacity-10 hover:bg-opacity-20 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-city"></i>
                        <span class="desktop-only text-sm font-medium">Add City</span>
                    </button>
                    
                    <button onclick="openModal('addCustModal')" class="px-4 py-2 bg-green-500 hover:bg-green-600 rounded-lg transition flex items-center gap-2 shadow-md">
                        <i class="fas fa-user-plus"></i>
                        <span class="desktop-only text-sm font-medium">Add Customer</span>
                    </button>
                    
                    <a href="/dashboard" class="px-4 py-2 bg-white bg-opacity-10 hover:bg-opacity-20 rounded-lg transition flex items-center gap-2">
                        <i class="fas fa-tachometer-alt"></i>
                        <span class="desktop-only text-sm font-medium">Dashboard</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 lg:px-6 py-6">
        
        <!-- Stats Summary -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 animate-fade-in">
            <div class="bg-white p-4 rounded-xl shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 font-medium">Total Customers</p>
                        <p class="text-2xl font-bold text-gray-800">{{ customers|length }}</p>
                    </div>
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-users text-blue-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded-xl shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 font-medium">Pending Orders</p>
                        <p class="text-2xl font-bold text-yellow-600">
                            {{ customers|selectattr('current_status', 'equalto', 'PENDING')|list|length }}
                        </p>
                    </div>
                    <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-clock text-yellow-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded-xl shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 font-medium">In Progress</p>
                        <p class="text-2xl font-bold text-blue-600">
                            {{ customers|selectattr('current_status', 'equalto', 'IN_PROGRESS')|list|length }}
                        </p>
                    </div>
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-truck text-blue-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded-xl shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 font-medium">Delivered</p>
                        <p class="text-2xl font-bold text-green-600">
                            {{ customers|selectattr('current_status', 'equalto', 'DELIVERED')|list|length }}
                        </p>
                    </div>
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Bulk Actions Section -->
        <div class="mb-6 animate-fade-in">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <!-- Search Form -->
                <form action="/customers" method="GET" class="w-full md:w-1/3 relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" 
                           name="search" 
                           value="{{ search_query }}" 
                           placeholder="Search by name, phone, city..." 
                           class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none shadow-sm">
                </form>

                <!-- Bulk Order Button (Hidden initially) -->
                <button id="bulkOrderBtn" 
                        onclick="submitBulkOrder()" 
                        class="hidden gradient-primary text-white px-6 py-3 rounded-xl shadow-md font-medium hover:opacity-90 transition flex items-center gap-2">
                    <i class="fas fa-box-open"></i>
                    <span class="desktop-only">Place Order for Selected</span>
                    <span class="mobile-only">Bulk Order</span>
                </button>
            </div>
        </div>

        <!-- Filter Buttons -->
        <div class="flex flex-wrap gap-2 mb-6">
            <span class="text-sm text-gray-600 font-medium w-full md:w-auto mb-2 md:mb-0">Filter by Status:</span>
            <div class="flex flex-wrap gap-2">
                <a href="/customers?filter_type=all" 
                   class="px-4 py-2.5 rounded-lg transition flex-1 text-center {% if active_filter == 'all' %} gradient-primary text-white shadow-lg {% else %} bg-white text-gray-700 shadow {% endif %}">
                    <i class="fas fa-layer-group mr-2"></i>
                    <span>All</span>
                </a>
                <a href="/customers?filter_type=delivered" 
                   class="px-4 py-2.5 rounded-lg transition flex-1 text-center {% if active_filter == 'delivered' %} gradient-success text-white shadow-lg {% else %} bg-white text-gray-700 shadow {% endif %}">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>Delivered</span>
                </a>
                <a href="/customers?filter_type=in_progress" 
                   class="px-4 py-2.5 rounded-lg transition flex-1 text-center {% if active_filter == 'in_progress' %} gradient-info text-white shadow-lg {% else %} bg-white text-gray-700 shadow {% endif %}">
                    <i class="fas fa-truck mr-2"></i>
                    <span>In Progress</span>
                </a>
                <a href="/customers?filter_type=pending" 
                   class="px-4 py-2.5 rounded-lg transition flex-1 text-center {% if active_filter == 'pending' %} gradient-warning text-white shadow-lg {% else %} bg-white text-gray-700 shadow {% endif %}">
                    <i class="fas fa-clock mr-2"></i>
                    <span>Pending</span>
                </a>
            </div>
        </div>
        
        <!-- Customer Table -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200 animate-fade-in">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 text-gray-600 text-xs uppercase font-semibold">
                        <tr>
                            <th class="p-4 border-b text-center w-12">
                                <input type="checkbox" 
                                       id="selectAll" 
                                       onclick="toggleAll(this)" 
                                       class="w-4 h-4 rounded text-purple-600 focus:ring-purple-500 cursor-pointer">
                            </th>
                            <th class="p-4 border-b">Customer Info</th>
                            <th class="p-4 border-b">Location</th>
                            <th class="p-4 border-b">GPS Status</th>
                            <th class="p-4 border-b">Order Status</th>
                            <th class="p-4 border-b w-48">Assigned Driver</th>
                            <th class="p-4 border-b text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 text-sm">
                        {% for c in customers %}
                        <tr class="table-row-hover transition">
                            <td class="p-4 text-center">
                                <input type="checkbox" 
                                       name="customer_select" 
                                       value="{{ c._id }}" 
                                       onclick="updateBulkBtn()" 
                                       class="w-4 h-4 rounded text-purple-600 cursor-pointer">
                            </td>
                            <td class="p-4">
                                <div class="font-bold text-gray-800">{{ c.name }}</div>
                                <div class="text-xs text-blue-600 font-medium">{{ c.phone_number }}</div>
                                <div class="text-[10px] text-gray-400 mt-1">
                                    <i class="far fa-clock mr-1"></i>
                                    {% if c.created_at %}
                                        {{ c.created_at.strftime('%d %b %Y') }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </div>
                            </td>
                            <td class="p-4">
                                <div class="text-gray-700 font-medium">{{ c.city }}</div>
                                <div class="text-xs text-gray-500 truncate w-32" title="{{ c.landmark }}">{{ c.landmark }}</div>
                                {% if c.pincode %}
                                <div class="text-[10px] text-gray-400">Pin: {{ c.pincode }}</div>
                                {% endif %}
                            </td>
                            <td class="p-4">
                                {% if c.is_verified %}
                                <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold flex items-center w-max gap-1">
                                    <i class="fas fa-map-marker-alt"></i> Verified
                                </span>
                                <div class="text-[10px] text-gray-400 mt-1 font-mono">
                                    {{ "%.4f"|format(c.verified_lat) if c.verified_lat else '' }}, {{ "%.4f"|format(c.verified_lng) if c.verified_lng else '' }}
                                </div>
                                {% else %}
                                <span class="bg-red-100 text-red-700 px-2 py-1 rounded text-[10px] font-bold flex items-center w-max gap-1">
                                    <i class="fas fa-times-circle"></i> Not Verified
                                </span>
                                {% endif %}
                            </td>
                            <td class="p-4">
                                {% if c.current_status == 'PENDING' %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 font-bold text-[10px]">
                                        <i class="fas fa-clock mr-1"></i> PENDING
                                    </span>
                                {% elif c.current_status == 'IN_PROGRESS' %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full bg-blue-100 text-blue-800 font-bold text-[10px]">
                                        <i class="fas fa-truck mr-1"></i> IN PROGRESS
                                    </span>
                                {% elif c.current_status == 'DELIVERED' %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full bg-green-100 text-green-800 font-bold text-[10px]">
                                        <i class="fas fa-check-circle mr-1"></i> DELIVERED
                                    </span>
                                {% else %}
                                    <span class="text-gray-400 text-[10px]">No Active Order</span>
                                {% endif %}
                            </td>
                            <td class="p-4">
                                {% if c.active_order_id and c.current_status in ['PENDING', 'IN_PROGRESS'] %}
                                    <select onchange="reassignDriver('{{ c.active_order_id }}', this.value)" 
                                            class="w-full text-[10px] border-gray-300 rounded focus:ring-purple-500 p-1 border bg-white shadow-sm">
                                        <option value="" disabled>Reassign Driver</option>
                                        {% for d in drivers %}
                                            <option value="{{ d._id }}" {% if d._id|string == c.assigned_driver_id %}selected{% endif %}>
                                                {{ d.name }} ({{ d.assigned_cities[0] if d.assigned_cities else 'N/A' }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                {% else %}
                                    <span class="text-xs text-gray-400 italic">--</span>
                                {% endif %}
                            </td>
                            <td class="p-4">
                                <div class="flex items-center justify-center gap-3">
                                    {% if c.current_status in ['PENDING', 'IN_PROGRESS'] %}
                                        <button disabled class="text-gray-300 cursor-not-allowed">
                                            <i class="fas fa-plus-circle text-xl"></i>
                                        </button>
                                    {% else %}
                                        <button onclick="openQuickAssignModal('{{ c._id }}', '{{ c.name }}', '{{ c.city }}')" 
                                                class="text-green-500 hover:text-green-700 transition transform hover:scale-110">
                                            <i class="fas fa-plus-circle text-xl"></i>
                                        </button>
                                    {% endif %}
                                    <button onclick="openEditModal('{{ c._id }}', '{{ c.name }}', '{{ c.phone_number }}', '{{ c.city }}', '{{ c.landmark }}', '{{ c.pincode or "" }}')" 
                                            class="text-gray-400 hover:text-blue-600 transition transform hover:scale-110">
                                        <i class="fas fa-edit text-lg"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Assign Order Modal -->
    <div id="assignModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Assign Delivery</h2>
                <button onclick="closeModal('assignModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-6">Order for <span id="assignCustName" class="font-bold text-gray-800"></span> in <span id="assignCity" class="font-bold text-indigo-600"></span></p>
            
            <form action="/create-order" method="POST" class="space-y-4">
                <input type="hidden" id="assignCustId" name="customer_id">
                
                <div class="space-y-3">
                    <label class="flex items-center p-4 border-2 border-indigo-100 rounded-xl cursor-pointer hover:bg-indigo-50 transition bg-indigo-50/50">
                        <input type="radio" name="driver_id" value="auto" checked class="w-5 h-5 text-indigo-600 focus:ring-indigo-500">
                        <div class="ml-4">
                            <p class="font-bold text-indigo-700">ðŸš€ Smart Auto-Assign</p>
                            <p class="text-[10px] text-indigo-500">Assigns to the least busy active driver in this city</p>
                        </div>
                    </label>

                    <div id="driverList" class="space-y-2 max-h-48 overflow-y-auto pr-1">
                        <!-- Drivers will be populated here -->
                    </div>

                    <label class="flex items-center p-4 border-2 border-gray-100 rounded-xl cursor-pointer hover:bg-gray-50 transition">
                        <input type="radio" name="driver_id" value="later" class="w-5 h-5 text-gray-400">
                        <div class="ml-4">
                            <p class="font-bold text-gray-700">ðŸ•’ Assign Later</p>
                            <p class="text-[10px] text-gray-500">Keep order unassigned for manual review</p>
                        </div>
                    </label>
                </div>

                <button type="submit" class="w-full gradient-primary text-white py-4 rounded-xl font-bold shadow-lg hover:opacity-90 transition mt-4 flex items-center justify-center gap-2">
                    <i class="fas fa-check-circle"></i> Confirm Order Creation
                </button>
            </form>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div id="addCustModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Register New Customer</h2>
                <button onclick="closeModal('addCustModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form action="/add-customer" method="POST" class="space-y-4">
                <input type="text" name="name" placeholder="Full Name *" 
                       class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" required>
                <input type="text" name="phone" placeholder="Phone Number *" 
                       class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" required>
                <select name="city" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none appearance-none" required>
                    {% for city in cities %}
                    <option value="{{ city.name }}">{{ city.name }}</option>
                    {% endfor %}
                </select>
                <input type="text" name="pincode" placeholder="Pincode" 
                       class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                <textarea name="landmark" placeholder="Complete Address & Landmark *" rows="3" 
                          class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" required></textarea>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('addCustModal')" 
                            class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="flex-1 gradient-success text-white py-3 rounded-lg font-medium shadow-md">
                        Register
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add City Modal -->
    <div id="addCityModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Add Service City</h2>
                <button onclick="closeModal('addCityModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form action="/add-city" method="POST" class="space-y-4">
                <input type="text" name="city_name" placeholder="Enter city name *" 
                       class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" required>
                <button type="submit" 
                        class="w-full gradient-primary text-white py-3 rounded-lg font-bold shadow-md hover:opacity-90 transition">
                    Add City
                </button>
            </form>
        </div>
    </div>

    <!-- Edit Customer Modal -->
    <div id="editCustModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Edit Customer</h2>
                <button onclick="closeModal('editCustModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form action="/update-customer" method="POST" class="space-y-4">
                <input type="hidden" id="edit_customer_id" name="customer_id">
                <input type="text" id="edit_name" name="name" placeholder="Full Name *" 
                       class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" required>
                <input type="text" id="edit_phone" name="phone_number" placeholder="Phone Number *" 
                       class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" required>
                <select id="edit_city" name="city" 
                        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none appearance-none" required>
                    {% for city in cities %}
                    <option value="{{ city.name }}">{{ city.name }}</option>
                    {% endfor %}
                </select>
                <input type="text" id="edit_pincode" name="pincode" placeholder="Pincode" 
                       class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                <textarea id="edit_landmark" name="landmark" placeholder="Address & Landmark *" rows="3" 
                          class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" required></textarea>
                <button type="submit" 
                        class="w-full gradient-primary text-white py-3 rounded-lg font-bold shadow-md">
                    Save Changes
                </button>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <div class="container mx-auto px-4 lg:px-6 py-6 mt-8">
        <div class="text-center text-gray-500 text-sm">
            <p>GasFlow Customer Management â€¢ {{ customers|length }} customers registered</p>
            <p class="mt-1">Â© 2023 GasFlow Delivery Services. All rights reserved.</p>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // Driver data passed from backend
        const allDrivers = {{ drivers|tojson|safe }}; 

        // Modal Logic
        function openModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        // Quick Assign Modal Logic
        function openQuickAssignModal(id, name, city) {
            document.getElementById('assignCustId').value = id;
            document.getElementById('assignCustName').textContent = name;
            document.getElementById('assignCity').textContent = city;

            const list = document.getElementById('driverList');
            list.innerHTML = "";
            
            // Normalize city name for accurate matching
            const targetCity = city.trim().toLowerCase();

            // Filter drivers who are active AND serve this city
            const cityDrivers = allDrivers.filter(d => 
                d.is_active && 
                d.assigned_cities && 
                d.assigned_cities.some(c => c && c.trim().toLowerCase() === targetCity)
            );

            if(cityDrivers.length > 0) {
                cityDrivers.forEach(d => {
                    list.innerHTML += `
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-blue-50 transition">
                            <input type="radio" name="driver_id" value="${d._id.$oid || d._id}" class="w-4 h-4 text-blue-600">
                            <div class="ml-3">
                                <p class="text-sm font-semibold text-gray-800">${d.name}</p>
                                <p class="text-[10px] text-gray-400">Direct Assign (Manual Override)</p>
                            </div>
                        </label>
                    `;
                });
            } else {
                list.innerHTML = `
                    <div class="p-3 bg-orange-50 border border-orange-200 rounded-lg flex items-start gap-2">
                        <i class="fas fa-exclamation-triangle text-orange-500 mt-0.5"></i>
                        <p class="text-[10px] text-orange-700 font-medium">
                            No active drivers found for "${city}". Orders can still be created and assigned later.
                        </p>
                    </div>
                `;
            }
            openModal('assignModal');
        }

        // Edit Modal Initialization
        function openEditModal(id, name, phone, city, landmark, pincode = '') {
            document.getElementById('edit_customer_id').value = id;
            document.getElementById('edit_name').value = name;
            document.getElementById('edit_phone').value = phone;
            document.getElementById('edit_city').value = city;
            document.getElementById('edit_landmark').value = landmark;
            document.getElementById('edit_pincode').value = pincode;
            openModal('editCustModal');
        }

        // Bulk Actions
        function toggleAll(source) {
            const checkboxes = document.getElementsByName('customer_select');
            for(let cb of checkboxes) {
                cb.checked = source.checked;
            }
            updateBulkBtn();
        }

        function updateBulkBtn() {
            const checked = document.querySelectorAll('input[name="customer_select"]:checked').length;
            const btn = document.getElementById('bulkOrderBtn');
            if (checked > 0) {
                btn.classList.remove('hidden');
                btn.innerHTML = `<i class="fas fa-box-open"></i><span class="desktop-only">Place Order for ${checked} Selected</span><span class="mobile-only">Order (${checked})</span>`;
            } else {
                btn.classList.add('hidden');
            }
        }

        async function submitBulkOrder() {
            const checkboxes = document.querySelectorAll('input[name="customer_select"]:checked');
            if(checkboxes.length === 0) return;
            if(!confirm(`Place auto-assigned orders for ${checkboxes.length} customers?`)) return;

            const formData = new FormData();
            Array.from(checkboxes).forEach(cb => formData.append('customer_ids', cb.value));

            try {
                const res = await fetch('/customers/bulk-order', { 
                    method: 'POST', 
                    body: formData 
                });
                const data = await res.json();
                if(data.success) {
                    showNotification(data.message, 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showNotification('Error: ' + data.message, 'error');
                }
            } catch (e) { 
                showNotification('Failed to place bulk order.', 'error'); 
            }
        }

        async function reassignDriver(orderId, driverId) {
            if (!driverId) return;
            const formData = new FormData();
            formData.append('order_id', orderId);
            formData.append('driver_id', driverId);

            try {
                const res = await fetch('/customers/reassign-driver', { 
                    method: 'POST', 
                    body: formData 
                });
                const data = await res.json();
                if(data.success) {
                    showNotification('Driver reassigned successfully!', 'success');
                } else {
                    showNotification('Failed: ' + data.message, 'error');
                }
            } catch (e) { 
                showNotification('Network error.', 'error'); 
            }
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i><span>${message}</span>`;
            container.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Close on Overlay click
        window.onclick = function(e) { 
            if (e.target.classList.contains('modal-overlay')) {
                closeModal(e.target.id);
            }
        }

        // Close on ESC key
        document.onkeydown = function(e) { 
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(m => {
                    closeModal(m.id);
                });
            }
        };

        // Initialize animations on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Add animation delays for table rows
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach((row, index) => {
                row.style.animationDelay = `${index * 0.05}s`;
            });
            
            // Focus search input on desktop
            const searchInput = document.querySelector('input[name="search"]');
            if (searchInput && window.innerWidth > 768) {
                setTimeout(() => {
                    searchInput.focus();
                }, 100);
            }
        });
    </script>
</body>
</html>