<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Fleet Tracking | GasFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        #map { height: calc(100vh - 80px); width: 100%; z-index: 1; background: #f8fafc; }
        .info-panel { position: absolute; top: 100px; left: 20px; z-index: 1000; width: 320px; }
        
        /* Custom Icon Styles */
        .marker-pin { display: flex; align-items: center; justify-content: center; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); width: 40px; height: 40px; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .marker-pin i { transform: rotate(45deg); font-size: 18px; color: white; }
        
        .pulse-car { position: relative; }
        .pulse-car::after { content: ''; position: absolute; width: 100%; height: 100%; border-radius: 50%; background: rgba(59, 130, 246, 0.4); animation: pulse-ring 2s infinite; }
        
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden">

    <div class="bg-white h-[80px] shadow-md flex items-center justify-between px-6 z-50 relative border-b border-gray-200">
        <div class="flex items-center gap-4">
            <a href="/dashboard" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full text-gray-500 hover:bg-indigo-600 hover:text-white transition-all">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div>
                <h1 class="text-xl font-bold text-gray-800">Tracking: <span class="text-indigo-600">{{ driver_name }}</span></h1>
                <p class="text-xs text-gray-500 font-medium uppercase tracking-widest flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Live Telemetry Active
                </p>
            </div>
        </div>
        <div class="flex gap-4">
            <div class="bg-indigo-50 border border-indigo-100 px-4 py-2 rounded-xl text-center">
                <p class="text-[10px] font-bold text-indigo-400 uppercase">Current Status</p>
                <p id="statusBadge" class="text-sm font-bold text-indigo-700">Connecting...</p>
            </div>
        </div>
    </div>

    <div class="relative">
        <div id="map"></div>
        
        <div class="info-panel space-y-4">
            <div class="bg-white/95 backdrop-blur shadow-2xl rounded-2xl p-5 border border-white/50">
                <h3 class="font-bold text-gray-800 mb-4 border-b pb-2 flex items-center justify-between">
                    <span>Navigation Details</span>
                    <i class="fas fa-location-crosshairs text-indigo-500"></i>
                </h3>
                
                <div class="space-y-4">
                    <div>
                        <p class="text-[10px] text-gray-400 font-black uppercase mb-1">Human Readable Address</p>
                        <p id="addressText" class="text-sm text-gray-800 font-medium leading-relaxed italic">Locating driver...</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                            <p class="text-[9px] text-indigo-400 font-bold uppercase">Latitude</p>
                            <p id="latText" class="font-mono text-xs font-bold text-indigo-700">-</p>
                        </div>
                        <div class="bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                            <p class="text-[9px] text-indigo-400 font-bold uppercase">Longitude</p>
                            <p id="lngText" class="font-mono text-xs font-bold text-indigo-700">-</p>
                        </div>
                    </div>

                    <div class="pt-2 border-t border-gray-100">
                        <div class="flex items-center justify-between text-xs mb-2">
                            <span class="flex items-center gap-2"><i class="fas fa-car text-blue-500"></i> Current Position</span>
                            <span class="flex items-center gap-2"><i class="fas fa-fire text-green-500"></i> Delivered</span>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="flex items-center gap-2"><i class="fas fa-fire text-orange-500"></i> Pending</span>
                            <span class="flex items-center gap-2 font-bold text-indigo-600"><i class="fas fa-arrow-right"></i> Travel Path</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const driverId = "{{ driver_id }}";
        let map, currentMarker, pathLine;
        const deliveryMarkers = [];

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([12.9716, 77.5946], 13);
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: 'Â©OpenStreetMap'
            }).addTo(map);

            fetchData();
            setInterval(fetchData, 8000); 
        }

        async function fetchData() {
            try {
                const response = await fetch(`/api/track-data/${driverId}`);
                const data = await response.json();
                if(data.current_pos) updateMap(data);
            } catch (e) { console.error("Update failed", e); }
        }

        function createIcon(type) {
            let color = '#f97316'; // Pending
            let icon = 'fa-fire';
            if (type === 'DELIVERED') color = '#10b981';
            if (type === 'DRIVER') { color = '#3b82f6'; icon = 'fa-car'; }

            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="marker-pin ${type === 'DRIVER' ? 'pulse-car' : ''}" style="background-color:${color}">
                        <i class="fas ${icon}"></i>
                       </div>`,
                iconSize: [40, 42],
                iconAnchor: [20, 42]
            });
        }

        function updateMap(data) {
            const { current_pos, path, markers } = data;

            // 1. Driver Location
            const driverLatLng = [current_pos.lat, current_pos.lng];
            if (!currentMarker) {
                currentMarker = L.marker(driverLatLng, { icon: createIcon('DRIVER') }).addTo(map);
                map.panTo(driverLatLng);
            } else {
                currentMarker.setLatLng(driverLatLng);
            }

            document.getElementById('latText').innerText = current_pos.lat.toFixed(5);
            document.getElementById('lngText').innerText = current_pos.lng.toFixed(5);
            document.getElementById('statusBadge').innerText = "MOVING";

            // 2. Path Arrows Logic
            const pathPoints = path.map(p => [p.lat, p.lng]);
            if (pathLine) pathLine.setLatLngs(pathPoints);
            else {
                pathLine = L.polyline(pathPoints, {
                    color: '#6366f1',
                    weight: 5,
                    opacity: 0.6,
                    dashArray: '10, 10'
                }).addTo(map);
            }

            // 3. Delivery Stations (Gas Icons)
            deliveryMarkers.forEach(m => map.removeLayer(m));
            deliveryMarkers.length = 0;

            markers.forEach(pt => {
                const m = L.marker([pt.lat, pt.lng], { icon: createIcon(pt.status) })
                    .bindPopup(`<div class="p-2 font-sans">
                                    <p class="font-bold text-indigo-600">${pt.customer}</p>
                                    <p class="text-xs text-gray-500">${pt.address}</p>
                                    <p class="mt-2 text-[10px] font-black uppercase text-gray-400">Status: ${pt.status}</p>
                                </div>`)
                    .addTo(map);
                deliveryMarkers.push(m);
            });

            reverseGeocode(current_pos.lat, current_pos.lng);
        }

        async function reverseGeocode(lat, lng) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await res.json();
                document.getElementById('addressText').innerText = data.display_name.split(',').slice(0, 3).join(',');
            } catch (e) { document.getElementById('addressText').innerText = "Street Location Detected"; }
        }

        window.onload = initMap;
    </script>
</body>
</html>