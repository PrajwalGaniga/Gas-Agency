<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Intelligence | {{ driver_name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA98WJQMxOftlN9q6zth9ax1n6rqBoWJ6g&libraries=geometry&callback=initMap" async defer></script>
    
    <style>
        #map { height: 100%; width: 100%; transition: all 0.3s ease; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .custom-marker { transition: transform 0.2s ease-out; }
        /* Custom scrollbar for sidebar */
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-900 h-screen overflow-hidden font-sans">

    <nav class="h-16 glass-panel border-b border-slate-200 px-6 flex items-center justify-between fixed top-0 w-full z-50">
        <div class="flex items-center gap-4">
            <a href="/dashboard" class="text-slate-500 hover:text-indigo-600 transition">
                <i class="fas fa-chevron-left text-xl"></i>
            </a>
            <div>
                <h1 class="text-xl font-black text-slate-800 tracking-tight">{{ driver_name }} <span class="text-xs font-normal text-slate-400 ml-2">Live Pathing</span></h1>
                <p class="text-[10px] text-indigo-500 font-bold uppercase tracking-widest" id="statusLabel">Initializing Satellite Link...</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <span class="bg-green-100 text-green-700 text-[10px] font-black px-3 py-1 rounded-full animate-pulse">LIVE CONNECTED</span>
            <button onclick="location.reload()" class="p-2 hover:bg-slate-100 rounded-lg transition"><i class="fas fa-sync-alt text-slate-600"></i></button>
        </div>
    </nav>

    <main class="flex h-full pt-16">
        <aside class="w-80 glass-panel border-r border-slate-200 hidden md:flex flex-col z-40">
            <div class="p-6 border-b border-slate-100">
                <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest mb-4">Shift Summary</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <p class="text-[10px] font-bold text-slate-400">Path Points</p>
                        <p class="text-lg font-black text-slate-800" id="pathCount">0</p>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <p class="text-[10px] font-bold text-slate-400">Total Orders</p>
                        <p class="text-lg font-black text-slate-800" id="markerCount">0</p>
                    </div>
                </div>
            </div>

            <div class="flex-grow sidebar-scroll overflow-y-auto p-6">
                <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest mb-4">Marker Legend</h3>
                <div class="space-y-4">
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-full bg-green-500 shadow-sm shadow-green-200"></div>
                        <span class="text-sm font-bold text-slate-600">Delivered (Verified)</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-full bg-blue-500 shadow-sm shadow-blue-200"></div>
                        <span class="text-sm font-bold text-slate-600">Ongoing (In-Transit)</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-full bg-orange-500 shadow-sm shadow-orange-200"></div>
                        <span class="text-sm font-bold text-slate-600">Pending Assignment</span>
                    </div>
                </div>
            </div>

            <div class="p-6 bg-indigo-600 text-white">
                <p class="text-[10px] font-black uppercase opacity-60 mb-1">Last Update Received</p>
                <p class="text-sm font-bold" id="lastSeen">Fetching...</p>
            </div>
        </aside>

        <section class="flex-grow relative">
            <div id="map"></div>
            
            <div class="absolute bottom-8 left-1/2 -translate-x-1/2 w-full max-w-xl px-4 z-40">
                <div class="glass-panel p-4 rounded-2xl shadow-2xl border border-white">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-black text-slate-500">ROUTE TIMELINE</span>
                        <span class="text-xs font-bold text-indigo-600" id="timeIndicator">00:00</span>
                    </div>
                    <input type="range" id="pathSlider" min="0" max="100" value="100" 
                           class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                </div>
            </div>
        </section>
    </main>

    <script>
        let map, poly, truckMarker;
        let pathData = [];

        async function initMap() {
            try {
                // 1. Fetch Data from our Senior API
                const res = await fetch('/api/track-data/{{ driver_id }}');
                const data = await res.json();
                
                if (!data.success) return;

                pathData = data.path;
                document.getElementById('pathCount').innerText = pathData.length;
                document.getElementById('markerCount').innerText = data.markers.length;
                document.getElementById('lastSeen').innerText = data.current_pos.last_seen || "Just now";
                document.getElementById('statusLabel').innerText = `Viewing Activity for ${data.date_label}`;

                const center = data.current_pos.lat ? data.current_pos : (pathData[0] || {lat: 12.9716, lng: 77.5946});

                // 2. Setup Google Map
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 15,
                    center: center,
                    styles: [
                        { "featureType": "poi", "stylers": [{ "visibility": "off" }] },
                        { "featureType": "transit", "stylers": [{ "visibility": "off" }] }
                    ],
                    disableDefaultUI: true,
                    zoomControl: true
                });

                // 3. ðŸ›°ï¸ Draw the Breadcrumb Trail (Polyline)
                poly = new google.maps.Polyline({
                    path: pathData,
                    geodesic: true,
                    strokeColor: "#6366f1",
                    strokeOpacity: 0.8,
                    strokeWeight: 6,
                    map: map
                });

                // 4. ðŸ“¦ Drop Status Markers
                data.markers.forEach(m => {
                    let markerColor = "orange";
                    if (m.status === 'DELIVERED') markerColor = "green";
                    if (m.status === 'IN_PROGRESS') markerColor = "blue";

                    const marker = new google.maps.Marker({
                        position: {lat: m.lat, lng: m.lng},
                        map: map,
                        title: m.customer,
                        icon: {
                            url: `http://maps.google.com/mapfiles/ms/icons/${markerColor}-dot.png`,
                            scaledSize: new google.maps.Size(40, 40)
                        }
                    });

                    const info = new google.maps.InfoWindow({
                        content: `<div class="p-2 font-sans"><b>${m.customer}</b><br><span class="text-xs">${m.address}</span><br><span class="text-indigo-600 font-bold">${m.status}</span></div>`
                    });
                    marker.addListener("click", () => info.open(map, marker));
                });

                // 5. ðŸš› Truck Icon for Live Position
                if (data.current_pos.lat) {
                    truckMarker = new google.maps.Marker({
                        position: data.current_pos,
                        map: map,
                        icon: {
                            url: 'https://cdn-icons-png.flaticon.com/512/3063/3063822.png',
                            scaledSize: new google.maps.Size(45, 45),
                            anchor: new google.maps.Point(22, 22)
                        }
                    });
                }

                // 6. ðŸ•’ Timeline Scrubbing Logic
                const slider = document.getElementById('pathSlider');
                slider.max = pathData.length - 1;
                slider.oninput = function() {
                    const point = pathData[this.value];
                    poly.setPath(pathData.slice(0, parseInt(this.value) + 1));
                    document.getElementById('timeIndicator').innerText = point.time || "--:--";
                };

            } catch (e) {
                console.error("Map Load Failed:", e);
                alert("Satellite Link Failed. Check your API Key and Network.");
            }
        }
    </script>
</body>
</html>